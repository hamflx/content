# è®°ä¸€æ¬¡å†…å­˜æ³„æ¼çš„æ’æŸ¥è¿‡ç¨‹

`JavaScript` æ˜¯æœ‰åƒåœ¾å›æ”¶æœºåˆ¶çš„ï¼Œä¸€èˆ¬ä¸å¤ªéœ€è¦è€ƒè™‘èµ„æºé‡Šæ”¾çš„é—®é¢˜ã€‚ç„¶è€Œï¼Œå³ä½¿æœ‰åƒåœ¾å›æ”¶å…œåº•ï¼Œä½†æ˜¯ä»£ç å†™çš„å¤ªè¿‡äºå¥”æ”¾ï¼Œä»ç„¶å­˜åœ¨ä¸å°çš„é—®é¢˜ã€‚è¿™ç¯‡æ–‡ç« å°±ä»¥ `********` æ’æŸ¥å‡ºçš„é—®é¢˜åšä¸ªç®€å•ä»‹ç»ï¼ˆæ³¨ï¼š`********` ä¸ºå†…éƒ¨é¡¹ç›®åç§°ï¼Œä¸‹åŒï¼‰ã€‚

## æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼

æœ‰ç”¨æˆ·åé¦ˆåœ¨ `********` ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¶å°”ä¼šå‡ºç°æµè§ˆå™¨å´©æºƒçš„é—®é¢˜ï¼Œç„¶ååœ¨ä¸€æ¬¡å‘ç‰ˆæœ¬çš„è¿‡ç¨‹ä¸­ï¼Œ`****` å‘ç°äº†å†…å­˜å ç”¨è¾¾åˆ°äº† `1GB` ç¨‹åº¦ï¼Œå¦‚ä¸‹å›¾ï¼ˆæˆªå›¾æ˜¯åæ¥æˆªçš„ï¼Œå«Œéº»çƒ¦å°±ç‚¹åˆ° `579MB`ï¼Œå¤šç‚¹å‡ æ¬¡æ€»æ˜¯èƒ½åˆ° `1GB` çš„ ğŸ˜ï¼‰ï¼š

![å†…å­˜å ç”¨](./assets/large-memory.png "å†…å­˜å ç”¨")

ä¸è¿‡è¿™ `579MB` æ˜¯æ­£å¸¸å†…å­˜å ç”¨ï¼Œè¿˜æ˜¯å†…å­˜æ³„æ¼äº†å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œå¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå†…å­˜å ç”¨æœªå¢åŠ ï¼Œæˆ–å¢åŠ çš„éƒ½èƒ½åœ¨ä¸€æ®µæ—¶é—´åï¼ˆ`GC` æ‰§è¡Œäº†ä¹‹åï¼‰æ­£å¸¸é‡Šæ”¾æ‰ï¼Œéƒ½æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœåœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå†…å­˜ä¸€ç›´å¢é•¿è€Œä»æœªå‡å°‘ï¼Œå³å­˜åœ¨å†…å­˜æ³„æ¼ã€‚

é€šè¿‡å¼€å‘è€…å·¥å…·é‡Œé¢çš„ `Memory` é¢æ¿ï¼Œå³å¯çœ‹åˆ°å†…å­˜å ç”¨ï¼Œä½¿ç”¨ `Heap snapshot` å·¥å…·å¯¹å†…å­˜å ç”¨åšå¿«ç…§ï¼Œåœ¨ä¸€é¡¿çŒ›çƒˆçš„æ“ä½œä¹‹å‰ä»¥åŠä¹‹åï¼Œåˆ†åˆ«åšå¿«ç…§ï¼Œç„¶åå¯¹æ¯”ä¸€ä¸‹å°±å¯ä»¥çŸ¥é“æœ‰æ²¡æœ‰å†…å­˜æ³„æ¼äº†ã€‚

ä»¥ `********` ä¸¾ä¾‹è¯¦ç»†è¯´ä¸‹æ­¥éª¤ï¼š

1. å¼„æ¸…æ¥šä½ è¦æ’æŸ¥å“ªä¸€æ­¥å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œæ¯”å¦‚æˆ‘éœ€è¦æ’æŸ¥ `A` ä¸ `B` é¡µé¢**æ¥å›åˆ‡æ¢æ—¶**ï¼Œæ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼ï¼›
2. å…ˆæ‰“å¼€ `********` çš„ B é¡µé¢**ç­‰å¾…åŠ è½½å®Œæ¯•**ï¼Œå› ä¸ºå¦‚æœä½ åˆ‡æ¢å¿«äº†ï¼Œå¯èƒ½ä¹Ÿä¼šé€ æˆå†…å­˜æ³„æ¼ï¼ˆæ¯”æ–¹è¯´ï¼Œåœ¨æ¥å£è¿”å›åæ·»åŠ äº‹ä»¶ï¼‰ï¼Œè¿™é‡Œè¦**ä¸€æ­¥æ­¥**æ’æŸ¥ï¼Œå°±æ˜¯æ§åˆ¶å˜é‡æ³•ï¼‰ï¼›
3. ç„¶å**åˆ‡æ¢åˆ° A é¡µé¢**ï¼Œåšå¿«ç…§ä¹‹å‰è¦**å…ˆ**æŠŠç›®æ ‡é¡µé¢**åŠ è½½ä¸€æ¬¡**ï¼Œå› ä¸ºâ€œå†·å¯åŠ¨â€ä¹Ÿæ˜¯è¦æ¶ˆè€—èµ„æºçš„ï¼›
4. å†åˆ‡æ¢å› B é¡µé¢ï¼Œåœ¨ `Memory` é¢æ¿ä¸­é€‰æ‹© `Heap snapshot` ç„¶åç‚¹ `Take snapshot` åšåˆå§‹çš„å¿«ç…§ï¼ˆåšå¿«ç…§ä¹‹å‰è¦ç‚¹å‡»ä¸€æ¬¡ `GC` æŒ‰é’®ï¼Œå‚ç…§ä¸‹å›¾ï¼‰ï¼›
5. ç‚¹å‡» A é¡µé¢ => ç‚¹å‡» B é¡µé¢ => ç‚¹å‡» A é¡µé¢ => ç‚¹å‡» B é¡µé¢ï¼Œåæ­£å°±æ˜¯ä¸€é¡¿æ“ä½œå°±æ˜¯äº†ï¼Œæ³¨æ„**æ‰‹é€Ÿ**ï¼Œ**ä¸è¦**æŠŠå…¶ä»–**ä¸ç¡®å®šå› ç´ **å¼•å…¥è¿›æ¥ï¼›
6. æœ€ååœç•™åœ¨åš**åˆå§‹å†…å­˜å¿«ç…§**çš„é¡µé¢ï¼Œè¿™é‡Œæ˜¯ B é¡µé¢ï¼Œç„¶åå†åšä¸€ä¸ªå†…å­˜å¿«ç…§ï¼ˆåˆ«å¿˜äº†å…ˆç‚¹ `GC` æŒ‰é’®ï¼‰ï¼›
7. å¯¹æ¯”ä¸€ä¸‹ä¸¤ä¸ªæ•°å­—å°±å¥½äº†ï¼Œå¦‚æœæ²¡æœ‰å¤ªå¤§å·®è·çš„è¯ï¼Œæ˜¾ç„¶æ˜¯æ²¡æœ‰å†…å­˜æ³„æ¼çš„ï¼ˆå½“ç„¶ï¼Œä¸ºäº†é¿å…è¯¯åˆ¤ï¼Œä½ å¯ä»¥å¤šé‡å¤å‡ æ¬¡ç¬¬ `5` æ­¥çš„æ“ä½œï¼‰ï¼Œå¦åˆ™ï¼Œå­˜åœ¨å†…å­˜æ³„æ¼ã€‚

![Memory é¢æ¿](./assets/devtools-memory-panel.png "Memory é¢æ¿")

ä¸‹é¢æ˜¯ `********` çš„ï¼ˆå½“ç„¶æ˜¯ç‚¹äº†å¾ˆå¤šå¾ˆå¤šæ¬¡æ‰ä¼šæœ‰è¿™ä¸ªæ•°æ®çš„ ğŸ¤£ï¼‰ï¼š

![å†…å­˜å¿«ç…§](./assets/memory-snapshots.png "å†…å­˜å¿«ç…§")

## æ’æŸ¥é—®é¢˜æ ¹æº

![å†…å­˜å¿«ç…§](./assets/memory-snapshot-summary.png "å†…å­˜å¿«ç…§")

æ‹¿å‡ºä¸Šé¢æ­¥éª¤çš„ç¬¬äºŒä¸ªå¿«ç…§ï¼ˆå›¾ç‰‡é‡Œåªæœ‰ä¸€ä¸ªæ˜¯å› ä¸ºæˆ‘æŠŠç¬¬ä¸€ä¸ªåˆ äº†ï¼‰ï¼Œå±•å¼€ `a`ï¼ˆå°±æ˜¯ `VueComponent`ï¼Œç»éªŒï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ª `a` çš„â€œä¸‰å›´â€ï¼š

- `Distance` 14 è¢«å¼•ç”¨çš„æ·±åº¦ï¼Œè¡¨ç¤ºç”± `GC` æ ¹ï¼ˆæ¯”å¦‚ `window` å¯¹è±¡ã€DOM æ•°æ ¹èŠ‚ç‚¹ï¼‰åˆ°è¯¥å¯¹è±¡ä¹‹é—´æœ€çŸ­çš„å¼•ç”¨æ•°é‡ã€‚
- `Shallow Size` æµ…å±‚å¤§å°ï¼Œè¯¥å¯¹è±¡æœ¬èº«çš„å¤§å°ã€‚
- `Reatined Size` ä¿ç•™å¤§å°ï¼Œè¡¨ç¤ºå¦‚æœå½“å‰å¯¹è±¡è¢«é‡Šæ”¾åï¼Œæ‰€æœ‰çš„ä» `GC` æ ¹æ— æ³•è¾¾åˆ°çš„å¯¹è±¡çš„æ€»çš„å¤§å°ï¼Œç®€å•ç‚¹è¯´ï¼Œé‡Šæ”¾äº†è¿™ä¸ªå¯¹è±¡ï¼Œèƒ½é‡Šæ”¾å¤šå°‘å†…å­˜ã€‚

æˆ‘ä»¬ä¸»è¦å…³æ³¨ `Distance` å’Œ `Reatined Size`ï¼Œå‰è€…å¦‚æœè¾ƒå¤§ï¼Œæˆ‘ä»¬å¯èƒ½å°±è¦å…³æ³¨ä¸€ä¸‹è¿™ä¸ªå¯¹è±¡æ˜¯ä¸æ˜¯æœ‰é—®é¢˜ã€‚æ¯”å¦‚ç¬¬ä¸€ä¸ª `a` å¯¹è±¡ï¼Œé¼ æ ‡æ‚¬æµ® `a @8001491` åï¼Œèƒ½çœ‹åˆ°è¯¥å¯¹è±¡çš„æ•°æ®ï¼š

![å†…å­˜å¿«ç…§-ç¬¬ä¸€ä¸ªaå¯¹è±¡](./assets/memory-snapshot-first-a-detail.png "å†…å­˜å¿«ç…§-ç¬¬ä¸€ä¸ªaå¯¹è±¡")

å‘ç°å®ƒæ˜¯ä¸€ä¸ª `Vue` ç»„ä»¶çš„å®ä¾‹ï¼Œé¼ æ ‡æ‚¬æµ®åˆ° `$el` çš„å€¼ä¸Šé¢ï¼Œå¦‚æœè¿™ä¸ªå…ƒç´ ä»ç„¶åœ¨é¡µé¢ä¸Šä¸”æ˜¯å¯è§çš„ï¼Œå®ƒå°±ä¼šåƒå®¡æŸ¥å…ƒç´ æ—¶ä¸€æ ·è¦†ç›–ä¸€å±‚è“è‰²çŸ©å½¢åŒºåŸŸï¼Œæ˜¾ç„¶è¿™ä¸ªæ²¡æœ‰ï¼ˆå¯ä»¥å†å±•å¼€å…¶å±æ€§ï¼Œçœ‹çœ‹ `isConnected`ã€`className`ã€`innerHTML` äº†è§£å…·ä½“æ˜¯å“ªé‡Œçš„é€»è¾‘ï¼Œä»¥åŠæ˜¯å¦ä» `DOM` æ ‘ä¸Šç§»é™¤äº†ï¼Œè¿™é‡Œçš„è¿™ä¸ªå®ä¾‹æ˜¯ä¸€ä¸ªè¡¨æ ¼ç»„ä»¶ï¼‰ã€‚è€Œå®ƒçš„ `Retained Size` åˆ™è¡¨ç¤ºäº†ï¼Œå¦‚æœæŠŠè¿™ä¸ªå¯¹è±¡ç»™é‡Šæ”¾äº†ï¼Œå¯ä»¥é‡Šæ”¾çº¦ `1MB` 2% çš„å†…å­˜ã€‚

ç‚¹å‡»è¿™ä¸ªå¯¹è±¡å¯ä»¥çœ‹åˆ°ç”±è¯¥å¯¹è±¡åˆ° `GC` æ ¹çš„å¼•ç”¨å…³ç³»ï¼š

![å†…å­˜å¿«ç…§](./assets/memory-snapshot-detail.png "å†…å­˜å¿«ç…§")

è¿™å¼ å›¾è¯´æ˜ï¼šè¿™ä¸ªè¡¨æ ¼ç»„ä»¶æ˜¯å¦ä¸€ä¸ª `a`ï¼ˆ`VueComponent`ï¼‰ç»„ä»¶çš„ `$parent` å±æ€§ï¼Œå³ä½œä¸ºå¦ä¸€ä¸ªç»„ä»¶çš„çˆ¶ç»„ä»¶è€Œè¢«å¼•ç”¨äº†ï¼Œä¸²è”èµ·æ¥å°±æ˜¯ï¼Œè¿™ä¸ªè¡¨æ ¼ç»„ä»¶è¢«å­ç»„ä»¶å¼•ç”¨äº†ï¼Œå­ç»„ä»¶åˆè¢«å­ç»„ä»¶å¼•ç”¨äº†è€Œå­ç»„ä»¶åˆè¢«å­ç»„ä»¶å¼•ç”¨äº†ï¼Œè€Œè¿™ä¸ªå­ç»„ä»¶åˆè¢«ä¸€ä¸ªæ–¹æ³•å¼•ç”¨äº†ï¼ˆè¿™ä¸ªæ–¹æ³•ä½¿ç”¨ `bind` ç»‘å®šäº†è¿™ä¸ªç»„ä»¶ï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•åˆè¢«ä½œä¸ºä¸€ä¸ª `DOM` å…ƒç´ çš„äº‹ä»¶è¢«å¼•ç”¨äº†ï¼Œè€Œè¿™ä¸ª `DOM` å…ƒç´ åˆè¢« `InternalNode` å¼•ç”¨äº†ï¼Œè¿™ä¸ª `InternalNode` å±äº `HTMLDocument`ã€‚

å³ï¼Œè¿™ä¸ªè¡¨æ ¼é‡Œé¢æœ‰ä¸ªç»„ä»¶æ·»åŠ äº†äº‹ä»¶ï¼Œä½†æ˜¯ç»„ä»¶é”€æ¯çš„æ—¶å€™æ²¡æœ‰æŠŠäº‹ä»¶ç§»é™¤ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªå…ƒç´ æ³„æ¼äº†ï¼Œå¯¼è‡´æ•´ä¸ªè¡¨æ ¼æ³„æ¼äº†ã€‚

å°†é¼ æ ‡æ‚¬æµ®åˆ° `bound_this in native_bind() @7606219` ä¸Šï¼Œå¯ä»¥çœ‹åˆ°ï¼š

![å†…å­˜å¿«ç…§](./assets/memory-snapshot-first-a-event.png "å†…å­˜å¿«ç…§")

æ‰¾åˆ°äº†è¿™ä¸ªè¢«æ·»åŠ è€Œæ²¡æœ‰è¢«ç§»é™¤çš„äº‹ä»¶å« `handleBlur`ã€‚OKï¼Œä½ ç°åœ¨æ˜¯ä¸æ˜¯æƒ³å…¨å±€æœç´¢ `handleBlur` æ–¹æ³•äº†ï¼Ÿ

![å†…å­˜å¿«ç…§](./assets/found-handle-blur.png "å†…å­˜å¿«ç…§")

è¿˜çœŸæœåˆ°äº†ã€‚ã€‚ã€‚ä¸è¿‡ï¼Œè¿™æ ·å¤ªéº»çƒ¦äº†ï¼Œå¯ä»¥çœ‹çœ‹è¿™ä¸ª `bind` ç»‘å®šçš„åˆ°åº•æ˜¯å“ªä¸ªç»„ä»¶ï¼Œä¹Ÿå°±æ˜¯é¼ æ ‡æ‚¬æµ®è¿™ä¸ªä¸Šé¢çš„é‚£ä¸€æ¡è®°å½• `$parent in a @9400441`ï¼Œå¯ä»¥çœ‹åˆ°ï¼š

![å†…å­˜å¿«ç…§](./assets/memory-snapshot-first-a-dep-detail.png "å†…å­˜å¿«ç…§")

é€šè¿‡å®¡æŸ¥è¿™ä¸ªå¯¹è±¡çš„ `$el` å¯ä»¥çŸ¥é“ï¼Œè¿™æ˜¯ä¸€ä¸ª `el-popover` ç»„ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ `el-popover` ç›‘å¬äº† `handleBlur` äº‹ä»¶ï¼Œä½†æ˜¯å´æ²¡æœ‰ç§»é™¤ï¼Œæ‰“å¼€ `element` ä»“åº“åœ¨ `packages\popover\src\main.vue` ä¸­æœç´¢ `handleBlur`ï¼š

![å†…å­˜å¿«ç…§](./assets/element-popover-handle-blur.png "å†…å­˜å¿«ç…§")

å¯ä»¥çœ‹åˆ°ï¼Œåªæ·»åŠ äº†è¯¥äº‹ä»¶ï¼Œè€Œæ²¡æœ‰ç§»é™¤è¯¥äº‹ä»¶ã€‚

## ä¿®å¤å†…å­˜æ³„æ¼é—®é¢˜

`Google` æœç´¢ `el-popover å†…å­˜æ³„æ¼`ï¼Œç„¶åå¤åˆ¶ã€ç²˜è´´ï¼Œ`over`ã€‚ä¸å¯¹ï¼Œæœç´¢ç»“æœç¬¬ä¸€æ¡æ˜¯ï¼š

> el-popover leaking memory Â· Issue #2561 Â· ElemeFE/element ...

2017 å¹´çš„ `Issue`ï¼Œç‚¹å¼€ä¸€çœ‹ï¼Œå¯¹åº”çš„ `PR` å·²ç»åˆå¹¶äº†ï¼Œè€Œä¸”æ˜¯ç‚¹å‡»äº‹ä»¶ï¼Œä¸æ˜¯ `focusout` äº‹ä»¶ï¼Œéš¾é“æ˜¯å®šä½é”™äº†ï¼Ÿå…¶å®ç”¨ `el-tooltip å†…å­˜æ³„æ¼`ã€`el-popover memory leak` ä¸ºå…³é”®å­—æœç´¢æ˜¯å¯ä»¥æœç´¢åˆ° [[Bug Report] Memory leak at el-tooltip cleanup](https://github.com/ElemeFE/element/issues/19370 "[Bug Report] Memory leak at el-tooltip cleanup")ï¼Œæè¿™ä¸ª `bug` çš„ä»å…„è¿˜æäº†ä¸¤ä¸ª `PR` ä¿®å¤ `el-tooltip`ï¼Œè¿˜æœ‰ä½ä»å…„ä¹Ÿæäº† `PR` ä¿®å¤ `el-tooltip` å’Œ `el-popover`ï¼Œç„¶è€Œã€‚ã€‚ã€‚

ä¸ºäº†ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œè€Œä¸å…‹éš† `element` ä»“åº“ï¼Œæˆ‘ä»¬å¯ä»¥é‡å†™å¯¹åº”çš„æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘æ‹¿ `el-tooltip` ä¸¾ä¾‹ï¼ŒåŸç‰ˆçš„ `el-tooltip` çš„ `mounted` ä»£ç å¦‚ä¸‹ï¼š

```javascript
export default {
    // code ...

    mounted() {
        this.referenceElm = this.$el;
        if (this.$el.nodeType === 1) {
            this.$el.setAttribute('aria-describedby', this.tooltipId);
            this.$el.setAttribute('tabindex', this.tabindex);
            on(this.referenceElm, 'mouseenter', this.show);
            on(this.referenceElm, 'mouseleave', this.hide);
            on(this.referenceElm, 'focus', () => {
                if (!this.$slots.default || !this.$slots.default.length) {
                    this.handleFocus();
                    return;
                }
                const instance = this.$slots.default[0].componentInstance;
                if (instance && instance.focus) {
                    instance.focus();
                } else {
                    this.handleFocus();
                }
            });
            on(this.referenceElm, 'blur', this.handleBlur);
            on(this.referenceElm, 'click', this.removeFocusing);
        }
    },

    // code ...

    destroyed() {
        const reference = this.referenceElm;
        if (reference.nodeType === 1) {
            off(reference, 'mouseenter', this.show);
            off(reference, 'mouseleave', this.hide);
            // è¿™é‡Œç§»é™¤äº† handleBlur æ–¹æ³•ï¼Œä½†æ˜¯å‰é¢æ·»åŠ çš„ä¸æ˜¯è¿™ä¸ªæ–¹æ³•ã€‚ã€‚ã€‚
            off(reference, 'focus', this.handleFocus);
            off(reference, 'blur', this.handleBlur);
            off(reference, 'click', this.removeFocusing);
        }
    }
}
```

é€šè¿‡å¦‚ä¸‹æ–¹æ³•é‡æ–°å®ç°å®ƒçš„ç›¸å…³æ–¹æ³•ï¼š

```javascript
import { Tooltip } from 'element-ui'
import { on } from 'element-ui/lib/utils/dom'

Tooltip.methods.handleFocus = function () {
  if (!this.$slots.default || !this.$slots.default.length) {
    this.doFocus()
    return
  }
  const instance = this.$slots.default[0].componentInstance
  if (instance && instance.focus) {
    instance.focus()
  } else {
    this.doFocus()
  }
}

Tooltip.methods.doFocus = function () {
  this.focusing = true
  this.show()
}

Tooltip.mounted = function () {
  this.referenceElm = this.$el
  if (this.$el.nodeType === 1) {
    this.$el.setAttribute('aria-describedby', this.tooltipId)
    // è¿™è¡Œä»£ç åœ¨ Element ä¸Šçš„æäº¤æ—¥å¿—æ˜¯ä¸ºäº†æ— éšœç¢è®¿é—®ï¼Œè¿™å°†å¯¼è‡´æµ‹è¯•æä¸€äº› bugï¼ˆç‚¹å‡»ç©ºç™½å¤„å…³é—­è¯¦æƒ…é¡µåï¼Œæ–‡å­—çš„ tooltip ä»ç„¶æ˜¾ç¤ºï¼‰ã€‚
    // this.$el.setAttribute('tabindex', 0)
    on(this.referenceElm, 'mouseenter', this.show)
    on(this.referenceElm, 'mouseleave', this.hide)
    on(this.referenceElm, 'focus', this.handleFocus)
    on(this.referenceElm, 'blur', this.handleBlur)
    on(this.referenceElm, 'click', this.removeFocusing)
  }
}

export default {
  install () {

  }
}
```

å³ï¼Œå°†åŸæ¥ç›´æ¥æ·»åŠ çš„äº‹ä»¶ï¼Œå†™æˆ `handleFocus` æ–¹æ³•ï¼ˆåŸæ¥ä¹Ÿæœ‰è¿™ä¸ªæ–¹æ³•ï¼Œæ•…æŠŠåŸæ¥çš„ `handleFocus` æ–¹æ³•æ”¹ä¸º `doFocus` æ–¹æ³•ï¼Œç„¶ååœ¨ `handleFocus` æ–¹æ³•é‡Œè°ƒç”¨ï¼Œè¿™æ ·å…¶ `destroyed` é‡Œé¢é‡Šæ”¾çš„äº‹ä»¶å°±æ˜¯æ·»åŠ çš„äº‹ä»¶äº†ã€‚

## å…¶ä»–é—®é¢˜

é€šè¿‡åŒæ ·çš„æ–¹å¼ï¼Œè¿˜å¯ä»¥æ‰¾åˆ°å®šæ—¶å™¨æœªé‡Šæ”¾ã€ç‚¹å‡»äº‹ä»¶æœªé‡Šæ”¾ä¹‹ç±»çš„é—®é¢˜ï¼Œä½†éƒ½æ˜¯é¡¹ç›®å†…çš„ä»£ç ï¼Œæ¯”è¾ƒå¥½è§£å†³å°±ä¸å±•å¼€äº†ã€‚

## æˆæœ

![å†…å­˜å¿«ç…§](./assets/result.png "å†…å­˜å¿«ç…§")

## æ·±å…¥æ€è€ƒ

ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰æ³¨æ„ï¼Œæœç´¢ä¸­æ–‡çš„ `el-popover` å†…å­˜æ³„æ¼æ²¡æœ‰æœç´¢åˆ°æƒ³è¦çš„ç»“æœï¼Œå…¶å®ä¸ç§»é™¤äº‹ä»¶ä¸€èˆ¬ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè€Œä¸”ä¸ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹æ¯”è¾ƒéš¾ä»¥å‘ç°è¿™ä¸ªé—®é¢˜ã€‚

ç°ä»£æµè§ˆå™¨éƒ½æ˜¯ç”¨ `æ ‡è®°`-`æ¸…é™¤` ç®—æ³•æˆ–åŸºäºå…¶æ”¹è¿›çš„ç®—æ³•æ¥å®ç°çš„åƒåœ¾å›æ”¶ã€‚å…¶åŸç†æ˜¯ä» `GC` æ ¹å¼€å§‹ï¼Œéå†æ‰€æœ‰å¼•ç”¨çš„å¯¹è±¡ï¼Œå¹¶å°†å…¶æ ‡è®°ï¼Œå½“ç®—æ³•éå†å®Œæ‰€æœ‰å¯¹è±¡åï¼Œé‚£äº›æœªè¢«æ ‡è®°çš„å¯¹è±¡å°†ä¼šè¢«æ¸…é™¤ã€‚

è€Œ `Vue.js` ä¼šåœ¨ç»„ä»¶è¢«é”€æ¯çš„æ—¶å€™ï¼Œé‡Šæ”¾å…¶å¼•ç”¨ï¼Œé‚£ä¹ˆå…¶å¼•ç”¨çš„å…ƒç´ ï¼Œä»¥åŠå…ƒç´ å¼•ç”¨çš„äº‹ä»¶éƒ½å°†æˆä¸ºæ— æ ¹æµ®èï¼Œä¼šè¢« `GC` å›æ”¶ã€‚

å†æ¬¡å®¡æŸ¥ä¸Šæ–‡ä¸­çš„è¡¨æ ¼ç»„ä»¶ï¼Œå¯ä»¥å‘ç° `V8EventListener` è¢« `Detached HTMLElement` å¼•ç”¨ï¼Œè€Œ `Detached HTMLElement` åˆè¢« `InternalNode` å¼•ç”¨ï¼Œè¿™ä¸ª `InternalNode` æ‰æ˜¯å®ƒæ²¡æœ‰è¢«é‡Šæ”¾çš„çœŸæ­£åŸå› ã€‚

è‡³äºè¿™ä¸ª `InternalNode` ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬ `N` æœŸä¹‹åå†è¯´ï¼ˆ`N â†’ âˆ`ï¼‰ã€‚

## å‚è€ƒèµ„æ–™

- [å†…å­˜æœ¯è¯­](https://developers.google.com/web/tools/chrome-devtools/memory-problems/memory-101?hl=zh-cn "å†…å­˜æœ¯è¯­")
- [å¦‚ä½•è®°å½•å †å¿«ç…§](https://developers.google.com/web/tools/chrome-devtools/memory-problems/heap-snapshots?hl=zh-cn "å¦‚ä½•è®°å½•å †å¿«ç…§")
- [[Bug Report] Memory leak at el-tooltip cleanup](https://github.com/ElemeFE/element/issues/19370 "[Bug Report] Memory leak at el-tooltip cleanup")
- [å†…å­˜ç®¡ç†](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Memory_Management "å†…å­˜ç®¡ç†")
